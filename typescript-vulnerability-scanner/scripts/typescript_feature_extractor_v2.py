#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
TypeScript Feature Extractor V2 - Análisis Contextual Mejorado
Reduce falsos positivos mediante análisis de contexto y patrones seguros
"""

import re
import numpy as np
from typing import Dict

class TypeScriptFeatureExtractorV2:
    """Extractor mejorado con análisis de contexto"""
    
    def __init__(self):
        # Patrones de código SEGURO que NO deben marcar como vulnerable
        self.safe_patterns = {
            'nestjs_bootstrap': [
                r'app\.use\(helmet\(\)\)',
                r'app\.enableCors\(',
                r'app\.useGlobalPipes\(',
                r'ValidationPipe',
                r'NestFactory\.create\(',
                r'await app\.listen\(',
            ],
            'nestjs_decorators': [
                r'@Module\(',
                r'@Controller\(',
                r'@Injectable\(',
                r'@UseGuards\(',
                r'createParamDecorator',
                r'ExecutionContext',
            ],
            'typeorm_safe': [
                r'@Entity\(',
                r'@Column\(',
                r'@PrimaryGeneratedColumn\(',
                r'repository\.find\(',
                r'repository\.findOne\(',
                r'repository\.save\(',
                r'where:\s*\{',
            ],
            'react_safe': [
                r'export default function',
                r'useEffect\(',
                r'useState\(',
                r'useRouter\(',
                r'className=',
                r'export const metadata',
            ],
            'security_libraries': [
                r'bcrypt\.hash\(',
                r'bcrypt\.compare\(',
                r'jwt\.sign\(',
                r'jwt\.verify\(',
                r'DOMPurify\.sanitize\(',
            ],
            'config_files': [
                r'export default.*Config',
                r'module\.exports\s*=\s*\{',
                r'tailwindcss:',
                r'autoprefixer:',
            ],
        }
        
        # Patrones de código VULNERABLE con contexto
        self.vulnerable_patterns = {
            'command_injection_dangerous': [
                r'exec\([^)]*\+',  # exec() con concatenación
                r'spawn\([^)]*\+',  # spawn() con concatenación
                r'execSync\([^)]*\$\{',  # execSync() con template strings no sanitizados
            ],
            'xss_dangerous': [
                r'innerHTML\s*=\s*[^"\']+\+',  # innerHTML con concatenación
                r'dangerouslySetInnerHTML.*\+',  # dangerouslySetInnerHTML con concatenación
                r'document\.write\(',  # document.write directo
            ],
            'sql_injection_dangerous': [
                r'query\([\'"][^\'"]*(SELECT|INSERT|UPDATE|DELETE)[^\'"]*\$\{',  # SQL con template strings
                r'raw\([\'"][^\'"]*(SELECT|INSERT|UPDATE|DELETE)[^\'"]*\+',  # SQL raw con concatenación
            ],
            'eval_dangerous': [
                r'eval\(',  # eval() siempre peligroso
                r'Function\([^)]*\+',  # new Function() con concatenación
            ],
        }
    
    def extract_features(self, code: str) -> Dict[str, float]:
        """Extrae características con análisis de contexto y devuelve como array numpy"""
        code = code.lower()
        features = {}
        
        # 1. Verificar si es código de framework SEGURO
        safe_score = self._calculate_safe_score(code)
        features['is_framework_code'] = safe_score
        
        # 2. Verificar patrones PELIGROSOS con contexto
        dangerous_score = self._calculate_dangerous_score(code)
        features['has_dangerous_patterns'] = dangerous_score
        
        # 3. Características de seguridad positivas
        features['uses_bcrypt'] = 1.0 if 'bcrypt' in code else 0.0
        features['uses_jwt'] = 1.0 if 'jwt' in code or 'jwtservice' in code else 0.0
        features['uses_helmet'] = 1.0 if 'helmet()' in code else 0.0
        features['uses_cors'] = 1.0 if 'enablecors' in code else 0.0
        features['uses_validation'] = 1.0 if 'validationpipe' in code else 0.0
        features['uses_typeorm'] = 1.0 if 'repository' in code and '@injectrepository' in code else 0.0
        
        # 4. Características de configuración
        features['is_config_file'] = 1.0 if any([
            'module.exports' in code and ('tailwindcss' in code or 'autoprefixer' in code),
            'nextconfig' in code,
            'tailwind' in code and 'config' in code,
            'postcss' in code and 'config' in code,
        ]) else 0.0
        
        # 5. Características de componentes React
        features['is_react_component'] = 1.0 if any([
            'export default function' in code and ('return' in code and '<' in code),
            'useeffect' in code,
            'usestate' in code,
            'metadata:' in code and 'metadata' in code,
        ]) else 0.0
        
        # 6. Características de NestJS
        features['is_nestjs_module'] = 1.0 if '@module(' in code else 0.0
        features['is_nestjs_controller'] = 1.0 if '@controller(' in code else 0.0
        features['is_nestjs_service'] = 1.0 if '@injectable(' in code and 'repository' in code else 0.0
        features['is_nestjs_decorator'] = 1.0 if 'createparamdecorator' in code else 0.0
        features['is_nestjs_guard'] = 1.0 if 'canactivate' in code and 'executioncontext' in code else 0.0
        
        # 7. Características de entidades TypeORM
        features['is_typeorm_entity'] = 1.0 if '@entity(' in code and '@column(' in code else 0.0
        
        # 8. Características de DTOs
        features['is_dto'] = 1.0 if any([
            'isstring' in code or 'isemail' in code,
            'minlength' in code or 'maxlength' in code,
        ]) else 0.0
        
        # 9. Características de enum/constantes
        features['is_enum'] = 1.0 if 'export enum' in code else 0.0
        
        # 10. Patrones peligrosos CONTEXTUALES
        features['dangerous_exec'] = self._check_dangerous_exec(code)
        features['dangerous_innerHTML'] = self._check_dangerous_innerHTML(code)
        features['dangerous_sql'] = self._check_dangerous_sql(code)
        features['dangerous_eval'] = 1.0 if 'eval(' in code else 0.0
        
        # 11. Características de sanitización
        features['has_sanitization'] = 1.0 if any([
            'sanitize' in code,
            'dompurify' in code,
            'validator' in code,
            'whitelist: true' in code,
            'textcontent' in code,  # Usar textContent en vez de innerHTML
        ]) else 0.0
        
        # 12. Características de validación de entrada
        features['has_input_validation'] = 1.0 if any([
            'validationpipe' in code,
            'class-validator' in code,
            '@is' in code,  # decoradores de class-validator
            'test(' in code and 'throw new error' in code,  # Validación manual con regex
            '/^[a-z' in code,  # Patrones regex de validación
            'joi.validate' in code,
        ]) else 0.0
        
        # 13. Uso de queries parametrizadas
        features['uses_parameterized_queries'] = 1.0 if any([
            'where: {' in code,
            'findone({' in code,
            'find({' in code,
            '$1' in code,  # PostgreSQL placeholders
            '?' in code and 'select' in code,  # SQL placeholders
        ]) else 0.0
        
        # 14. Detección de hardcoded secrets (MALO)
        features['has_hardcoded_secrets'] = 1.0 if re.search(
            r'(password|secret|token|key)\s*=\s*[\'"][^\'"]{8,}[\'"]',
            code
        ) else 0.0
        
        # 15. Uso de variables de entorno (BUENO)
        features['uses_env_vars'] = 1.0 if any([
            'process.env' in code,
            'configservice' in code,
            '.env' in code,
        ]) else 0.0
        
        # CARACTERÍSTICAS ADICIONALES (completar hasta 38)
        features['line_count'] = min(len(code.split('\n')) / 500.0, 1.0)
        features['has_imports'] = 1.0 if 'import' in code or 'require(' in code else 0.0
        features['has_exports'] = 1.0 if 'export' in code or 'module.exports' in code else 0.0
        features['has_async'] = 1.0 if 'async' in code or 'await' in code else 0.0
        features['has_try_catch'] = 1.0 if 'try' in code and 'catch' in code else 0.0
        
        # XSS patterns
        features['xss_innerHTML'] = 1.0 if 'innerhtml' in code else 0.0
        features['xss_dangerouslySetInnerHTML'] = 1.0 if 'dangerouslysetinnerhtml' in code else 0.0
        features['xss_documentWrite'] = 1.0 if 'document.write' in code else 0.0
        
        # Command Injection patterns
        features['cmd_exec'] = 1.0 if ('exec(' in code or 'execsync(' in code) and 'execfile(' not in code.lower() else 0.0
        features['cmd_spawn'] = 1.0 if 'spawn(' in code or 'spawnsync(' in code else 0.0
        features['cmd_child_process'] = 1.0 if 'child_process' in code else 0.0
        
        # SQL Injection patterns
        features['sql_raw_query'] = 1.0 if 'raw(' in code or '.query(' in code else 0.0
        features['sql_string_concat'] = 1.0 if re.search(r'(select|insert|update|delete).*\+', code) else 0.0
        
        # Path Traversal patterns
        features['path_traversal'] = 1.0 if re.search(r'\.\./|\\\.\\\.', code) else 0.0
        features['path_join'] = 1.0 if 'path.join' in code else 0.0
        
        # Code Injection patterns
        features['code_eval'] = 1.0 if 'eval(' in code else 0.0
        features['code_function_constructor'] = 1.0 if 'new function' in code else 0.0
        
        # SCORE FINAL AJUSTADO
        # Si es código de framework con score alto, reducir probabilidad de vulnerable
        if safe_score > 0.5:
            features['framework_safety_bonus'] = safe_score
        else:
            features['framework_safety_bonus'] = 0.0
        
        # Convertir diccionario a array en orden consistente
        feature_names = self.get_feature_names()
        feature_array = [features.get(name, 0.0) for name in feature_names]
        
        return np.array(feature_array)
    
    def _calculate_safe_score(self, code: str) -> float:
        """Calcula score de código seguro (0.0 a 1.0)"""
        matches = 0
        total_patterns = 0
        
        for category, patterns in self.safe_patterns.items():
            for pattern in patterns:
                total_patterns += 1
                if re.search(pattern, code, re.IGNORECASE):
                    matches += 1
        
        return matches / max(total_patterns, 1)
    
    def _calculate_dangerous_score(self, code: str) -> float:
        """Calcula score de código peligroso (0.0 a 1.0)"""
        matches = 0
        total_patterns = 0
        
        for category, patterns in self.vulnerable_patterns.items():
            for pattern in patterns:
                total_patterns += 1
                if re.search(pattern, code, re.IGNORECASE):
                    matches += 1
        
        return matches / max(total_patterns, 1)
    
    def _check_dangerous_exec(self, code: str) -> float:
        """Verifica si exec() es peligroso (con concatenación)"""
        # execFile es más seguro que exec - no usar shell
        if 'execfile(' in code.lower():
            # Si tiene validación de input, es seguro
            if 'test(' in code and 'throw new error' in code.lower():
                return 0.1  # Muy seguro con validación
            return 0.2  # execFile es inherentemente más seguro
        
        # exec() y execSync() son peligrosos
        if 'exec(' not in code and 'execsync(' not in code:
            return 0.0
        
        # Si tiene concatenación con +, ${}, o variables, es peligroso
        if re.search(r'exec\([^)]*\+', code):
            return 1.0
        if re.search(r'exec\([^)]*\$\{', code):
            return 1.0
        
        # Si es exec() con string literal, es menos peligroso
        if re.search(r'exec\([\'"][^\'"]*[\'"]', code):
            return 0.3  # Aún puede ser peligroso pero menos
        
        return 0.5
    
    def _check_dangerous_innerHTML(self, code: str) -> float:
        """Verifica si innerHTML es peligroso"""
        if 'innerhtml' not in code:
            return 0.0
        
        # Si tiene concatenación, muy peligroso
        if re.search(r'innerhtml\s*=\s*[^"\']+\+', code):
            return 1.0
        
        # Si usa DOMPurify.sanitize, es seguro
        if 'dompurify.sanitize' in code:
            return 0.0
        
        # innerHTML en general es sospechoso
        return 0.6
    
    def _check_dangerous_sql(self, code: str) -> float:
        """Verifica si hay SQL injection"""
        if 'select' not in code and 'insert' not in code and 'update' not in code:
            return 0.0
        
        # Si usa TypeORM repository methods, es seguro
        if 'repository.find' in code or 'repository.findone' in code:
            return 0.0
        
        # Si usa where: { }, es seguro (query parametrizada)
        if re.search(r'where:\s*\{', code):
            return 0.0
        
        # Si usa raw() con concatenación, MUY peligroso
        if re.search(r'raw\([^)]*\+', code):
            return 1.0
        
        # Si usa query() con template strings, peligroso
        if re.search(r'query\([^)]*\$\{', code):
            return 1.0
        
        return 0.3
    
    def get_feature_names(self):
        """Retorna nombres de todas las características"""
        return [
            'is_framework_code',
            'has_dangerous_patterns',
            'uses_bcrypt',
            'uses_jwt',
            'uses_helmet',
            'uses_cors',
            'uses_validation',
            'uses_typeorm',
            'is_config_file',
            'is_react_component',
            'is_nestjs_module',
            'is_nestjs_controller',
            'is_nestjs_service',
            'is_nestjs_decorator',
            'is_nestjs_guard',
            'is_typeorm_entity',
            'is_dto',
            'is_enum',
            'dangerous_exec',
            'dangerous_innerHTML',
            'dangerous_sql',
            'dangerous_eval',
            'has_sanitization',
            'has_input_validation',
            'uses_parameterized_queries',
            'has_hardcoded_secrets',
            'uses_env_vars',
            'line_count',
            'has_imports',
            'has_exports',
            'has_async',
            'has_try_catch',
            'xss_innerHTML',
            'xss_dangerouslySetInnerHTML',
            'xss_documentWrite',
            'cmd_exec',
            'cmd_spawn',
            'cmd_child_process',
            'sql_raw_query',
            'sql_string_concat',
            'path_traversal',
            'path_join',
            'code_eval',
            'code_function_constructor',
            'framework_safety_bonus',
        ]
